#include "i_video.h"
#include "u_error.h"
#include "u_format.h"
#include "y_log.h"

#include <stdbool.h>
#include <stdint.h>
#include <string.h>

#define ERRPREFIX "Fatal error: "

static char errorbuf[256];

intptr_t jumpbuffer[5];

// https://www.romhacking.net/fonts/142/
// Stored as columns of bits
static const uint8_t errorfont[] = {
    0x00,0x00,0x00,0x7a,0x00,0x60,0x00,0x60,0x00,0x28,0x7c,0x28,0x7c,0x28,0x00,0x12,
    0x2f,0x7a,0x24,0x00,0x63,0x6c,0x1b,0x63,0x00,0x2c,0x52,0x2a,0x04,0x0a,0x00,0x60,
    0x00,0x1c,0x22,0x41,0x00,0x41,0x22,0x1c,0x00,0x28,0x10,0x7c,0x10,0x28,0x00,0x10,
    0x10,0x7c,0x10,0x10,0x03,0x00,0x10,0x10,0x10,0x10,0x00,0x02,0x00,0x03,0x0c,0x18,
    0x60,0x00,0x3c,0x42,0x42,0x3c,0x00,0x00,0x20,0x7e,0x00,0x00,0x26,0x4a,0x4a,0x32,
    0x00,0x04,0x52,0x52,0x2c,0x00,0x18,0x28,0x48,0x7e,0x00,0x34,0x52,0x52,0x4c,0x00,
    0x3c,0x52,0x52,0x0c,0x00,0x40,0x46,0x58,0x60,0x00,0x2c,0x52,0x52,0x2c,0x00,0x30,
    0x4a,0x4a,0x3c,0x00,0x22,0x00,0x23,0x00,0x08,0x14,0x14,0x22,0x00,0x24,0x24,0x24,
    0x24,0x00,0x22,0x14,0x14,0x08,0x00,0x20,0x40,0x4a,0x30,0x00,0x1e,0x21,0x4c,0x52,
    0x5e,0x22,0x1e,0x00,0x0e,0x38,0x48,0x38,0x0e,0x00,0x7e,0x52,0x52,0x52,0x2c,0x00,
    0x3c,0x42,0x42,0x42,0x24,0x00,0x7e,0x42,0x42,0x42,0x3c,0x00,0x7e,0x52,0x52,0x52,
    0x42,0x00,0x7e,0x50,0x50,0x50,0x40,0x00,0x3c,0x42,0x42,0x4a,0x2e,0x00,0x7e,0x10,
    0x10,0x10,0x7e,0x00,0x7e,0x00,0x01,0x7e,0x00,0x7e,0x08,0x18,0x24,0x42,0x00,0x7e,
    0x02,0x02,0x02,0x02,0x00,0x7e,0x30,0x0c,0x0c,0x30,0x7e,0x00,0x7e,0x20,0x18,0x04,
    0x7e,0x00,0x3c,0x42,0x42,0x42,0x3c,0x00,0x7e,0x48,0x48,0x48,0x30,0x00,0x3c,0x42,
    0x42,0x42,0x3d,0x00,0x7e,0x48,0x48,0x4c,0x32,0x00,0x24,0x52,0x52,0x4a,0x24,0x00,
    0x40,0x40,0x7e,0x40,0x40,0x00,0x7c,0x02,0x02,0x02,0x7c,0x00,0x70,0x0c,0x02,0x0c,
    0x70,0x00,0x78,0x06,0x38,0x38,0x06,0x78,0x00,0x42,0x24,0x18,0x24,0x42,0x00,0x40,
    0x20,0x1e,0x20,0x40,0x00,0x46,0x4a,0x4a,0x52,0x62,0x00,0x7f,0x41,0x41,0x00,0x60,
    0x18,0x0c,0x03,0x00,0x41,0x41,0x7f,0x00,0x10,0x20,0x40,0x20,0x10,0x00,0x01,0x01,
    0x01,0x01,0x01,0x40,0x20,0x00,0x04,0x2a,0x2a,0x1e,0x00,0x7e,0x22,0x22,0x1c,0x00,
    0x1c,0x22,0x22,0x14,0x00,0x1c,0x22,0x22,0x7e,0x00,0x1c,0x2a,0x2a,0x1a,0x00,0x10,
    0x3e,0x50,0x40,0x18,0x25,0x25,0x3e,0x00,0x7e,0x20,0x20,0x1e,0x00,0x5e,0x00,0x01,
    0x5e,0x00,0x7e,0x08,0x14,0x22,0x00,0x7c,0x02,0x00,0x3e,0x20,0x1e,0x20,0x1e,0x00,
    0x3e,0x20,0x20,0x1e,0x00,0x1c,0x22,0x22,0x1c,0x00,0x3f,0x24,0x24,0x18,0x00,0x18,
    0x24,0x24,0x3f,0x00,0x3e,0x20,0x20,0x00,0x12,0x2a,0x2a,0x24,0x00,0x20,0x7c,0x22,
    0x00,0x3c,0x02,0x02,0x3e,0x00,0x38,0x06,0x06,0x38,0x00,0x38,0x06,0x18,0x06,0x38,
    0x00,0x36,0x08,0x08,0x36,0x00,0x31,0x0a,0x0c,0x30,0x00,0x26,0x2a,0x2a,0x32,0x00,
    0x08,0x36,0x41,0x41,0x00,0x7f,0x00,0x41,0x41,0x36,0x08,0x00,0x20,0x40,0x20,0x40,
    0x00,0x0e,0x12,0x22,0x12,0x0e,0x00,
};

// Offsets into the table of bits where each character's columns are.
static const uint16_t errorfontoffsets[97] = {
      0,  3,  5,  9, 15, 20, 25, 31, 33, 37, 41, 47, 52, 54, 59, 61,
     66, 71, 76, 81, 86, 91, 96,101,106,111,116,118,120,125,130,135,
    140,148,154,160,166,172,178,184,190,196,198,201,207,213,220,226,
    232,238,244,250,256,262,268,274,281,287,293,299,303,308,312,318,
    323,326,331,336,341,346,351,355,360,365,367,370,375,378,384,389,
    394,399,404,408,413,417,422,427,433,438,443,448,453,455,460,465,
    471,
};

static void DrawMessage(const char *message) {
    uint8_t *framebuffer = I_GetFramebuffer();
    // Clear framebuffer.
    memset(framebuffer, 0, 52 * SCREENHEIGHT);
    // Plot font pixels onto screen.
    uint8_t c;
    uint8_t y = 0;
    uint16_t x = 0;
    while ((c = *message++)) {
        // Check if new line.
        if (c == '\n') {
            y += 8;
            // Check if we went off screen.
            if (y == SCREENHEIGHT) {
                break;
            }
            x = 0;

            continue;
        }

        // Check if non-ASCII character.
        if (c < 0x20 || c > 0x7f) {
            // Replace with '?'
            c = '?';
        }
        c -= 0x20;

        // Calculate width of character by subtracting offsets.
        uint8_t width = errorfontoffsets[c + 1] - errorfontoffsets[c];

        // Check if room to print.
        if (x + width > SCREENWIDTH) {
            y += 8;
            // Check if we went off screen.
            if (y == SCREENHEIGHT) {
                break;
            }
            x = 0;
        }

        // Print character.
        uint32_t xindex = ((y * 52) + (x >> 3));
        uint8_t xmask = (1 << (7 - (x & 7)));
        const uint8_t *src = &errorfont[errorfontoffsets[c]];
        do {
            uint8_t column = *src++;
            for (uint8_t j = 0; j < 8; j++) {
                if (column & 0x80) {
                    framebuffer[xindex + (j * 52)] |= xmask;
                }
                column <<= 1;
            }
            xmask >>= 1;
            if (xmask == 0) {
                xmask = 0x80;
                xindex += 1;
            }
            ++x;
        } while (--width);
    }
    I_MarkFramebufferDirty();
}

noreturn void Error(const char *fmt, ...) {
    // Add text to the error buffer indicating that it's an error.
    strcpy(errorbuf, ERRPREFIX);
    // Print the error message to the remaining part of the buffer.
    va_list list;
    va_start(list, fmt);
    FormatStringV(errorbuf + strlen(ERRPREFIX), sizeof(errorbuf) - strlen(ERRPREFIX), fmt, list);
    va_end(list);
    // Draw error text.
    DrawMessage(errorbuf);
    // Log the message in the console as well, in case the application
    // terminates before we can see it.
    Y_Log("%s", errorbuf);
#ifdef __EMSCRIPTEN__
    // Raise a trap as nonlocal gotos are not yet in WebAssembly.
    __builtin_unreachable();
#else
    __builtin_longjmp(jumpbuffer, 1);
#endif
}
